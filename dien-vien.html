<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh Sách Diễn Viên</title>
    <style>
        /* --- Reset & Base --- */
        * {
            box-sizing: border-box;
        }

        body {
            background-color: #111319;
            font-family: 'SF Pro', 'Roboto', 'Noto Sans', sans-serif;
            margin: 0;
            padding: 0;
            color: #fff;
            font-size: 14px;
            overflow-x: hidden;
        }

        a {
            text-decoration: none;
            color: inherit;
            cursor: pointer;
        }

        img {
            border: none;
            vertical-align: top;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* --- CONTAINER CHÍNH --- */
        .main-container {
            padding: 40px 60px;
            max-width: 1920px;
            margin: 0 auto;
        }

        /* --- GRID DIỄN VIÊN (4 CỘT - PC) --- */
        #castListContainer {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            width: 100%;
            align-items: start;
        }

        /* --- KHỐI NGƯỜI (CARD CHÍNH) --- */
        .person-block {
            background-color: rgb(26, 28, 34);
            border-radius: 4px;
            padding: 24px 20px 20px 20px;
            display: flex;
            flex-direction: column;
            height: auto;
            transition: background-color 0.2s;
        }

        /* Header: Avatar + Tên + Vai trò + Dòng kẻ */
        .person-header {
            display: flex;
            align-items: center;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
            transition: all 0.3s;
        }

        /* --- AVATAR (PC) --- */
        .person-avatar {
            width: 74.31px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 14px;
            background: #23252b;
            flex-shrink: 0;
            cursor: pointer;
        }

        /* --- KHỐI CHỨA TÊN VÀ ROLE --- */
        .person-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex-grow: 1;
            position: relative;
            /* Để định vị nút Khác */
        }

        /* --- TÊN DIỄN VIÊN (PC) --- */
        .person-name {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
            /* Tránh đè lên nút Khác */
        }

        /* --- CHỨC VỤ (PC) --- */
        .person-role {
            font-size: 14px;
            color: #83858a;
            font-weight: 400;
        }

        /* --- NÚT KHÁC (PC) --- */
        .more-link {
            position: absolute;
            bottom: 0;
            /* Căn đáy với khối person-info */
            right: 0;
            /* Căn phải */
            color: #1CC749;
            font-size: 14px;
            font-weight: 400;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .more-link:hover {
            text-decoration: none;
            opacity: 0.8;
        }

        .more-link svg {
            margin-left: 2px;
            width: 12px;
            height: 12px;
        }

        /* --- GRID PHIM --- */
        .person-movies-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: auto;
            justify-items: center;
        }

        /* --- CARD PHIM --- */
        .movie-card-vertical {
            cursor: pointer;
            position: relative;
            width: 198px;
            transform-origin: center center;
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .movie-card-vertical:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .poster-box {
            position: relative;
            width: 198px;
            height: 263.98px;
            border-radius: 0;
            overflow: hidden;
            background: #23252b;
            margin-bottom: 10px;
        }

        .poster-box img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .poster-overlay-gradient {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60%;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, transparent 100%);
            pointer-events: none;
            z-index: 2;
            opacity: 1;
        }

        .play-btn-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            width: 42px;
            height: 42px;
            z-index: 5;
            opacity: 0;
            transition: none;
        }

        .play-btn-center svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
        }

        .movie-card-vertical:hover .play-btn-center {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .collection-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 42px;
            height: 42px;
            background-color: #ffffff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 6;
            cursor: pointer;
            opacity: 0;
            transform: translateY(0);
            transition: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .collection-btn svg {
            width: 30px;
            height: 30px;
            display: block;
            fill: #111319;
        }

        .movie-card-vertical:hover .collection-btn {
            opacity: 1;
        }

        .collection-btn:hover {
            transform: scale(1.1);
            transition: transform 0.1s;
        }

        .tooltip-text {
            position: absolute;
            right: 55px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(30, 30, 30, 0.9);
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 400;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: none;
            pointer-events: none;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 50%;
            right: -4px;
            margin-top: -4px;
            border-width: 4px 0 4px 4px;
            border-style: solid;
            border-color: transparent transparent transparent rgba(30, 30, 30, 0.9);
        }

        .collection-btn:hover .tooltip-text {
            opacity: 1;
            visibility: visible;
        }

        .poster-title {
            font-size: 16px;
            font-weight: 400;
            color: #dcdcdc;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-top: 0;
            transition: color 0.2s;
        }

        .movie-card-vertical:hover .poster-title {
            color: #1CC749;
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 1600px) {
            .main-container {
                padding: 30px;
            }
        }

        @media (max-width: 1200px) {
            #castListContainer {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* --- MOBILE RESPONSIVE FIX (PHONE) --- */
        @media (max-width: 768px) {
            .main-container {
                padding: 16px;
                width: 100vw;
                overflow-x: hidden;
            }

            #castListContainer {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .person-block {
                background-color: transparent;
                padding: 0;
                border-radius: 0;
                border-bottom: none;
                padding-bottom: 10px;
                margin-bottom: 0;
            }

            .person-block:hover {
                background-color: transparent;
            }

            .person-header {
                border-bottom: none;
                padding-bottom: 0;
                margin-bottom: 15px;
            }

            .person-avatar {
                width: 60px;
                height: 60px;
            }

            .person-name {
                font-size: 16px;
                font-weight: 500;
            }

            .person-role {
                font-size: 12px;
                font-weight: 500;
            }

            .more-link {
                font-size: 12px;
                font-weight: 500;
            }

            .person-movies-grid {
                display: grid;
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 12px;
                width: 100%;
            }

            .movie-card-vertical {
                width: 100%;
                aspect-ratio: 198 / 263.98;
            }

            .poster-box {
                width: 100%;
                height: 100%;
                margin-bottom: 8px;
            }

            .poster-title {
                padding: 0.1rem 0px 0px;
                font-size: 14px;
                transition: color 0.3s;
            }

            .play-btn-center,
            .collection-btn {
                display: none !important;
            }
        }
    </style>
</head>

<body>

    <div class="main-container">
        <div id="loadingMsg" style="color:#666; font-size:16px;">Đang tải dữ liệu...</div>
        <div id="castListContainer"></div>
    </div>

    <script>
        const TMDB_API_KEY = 'd628e326b0c87e3f67133dabc797e5d0';
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/w500';
        const PHIMAPI_IMAGE_BASE = 'https://phimimg.com/';

        // SVG Play
        const playBtnSvg = `
            <svg viewBox="0 0 60 60" version="1.1" xmlns="http://www.w3.org/2000/svg">
                <circle cx="30" cy="30" r="30" fill="rgb(28, 199, 73)"></circle>
                <path d="M35.75,22.5 L45.14,36.6 C46.06,38 45.69,39.8 44.3,40.7 C43.8,41.1 43.2,41.25 42.6,41.25 L23.85,41.25 C22.2,41.25 20.85,39.9 20.85,38.25 C20.85,37.65 21,37.1 21.35,36.6 L30.75,22.5 C31.67,21.1 33.5,20.7 34.9,21.6 C35.2,21.9 35.5,22.2 35.75,22.5 Z" fill="#000000" transform="translate(33.25, 30.00) rotate(-270.00) translate(-33.25, -30.00) "></path>
            </svg>
        `;

        // SVG Collection
        const collectionBtnSvg = `
            <svg viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M29.3,17.25 C29.7,17.25 30,17.56 30,17.94 L30,19.4 C30,19.8 29.7,20.1 29.3,20.1 L22.9,20.1 L22.9,39.7 L28.6,34.9 C29.4,34.3 30.4,34.3 31.2,34.8 L31.4,34.9 L37.1,39.7 L37.1,33.5 C37.1,33.1 37.4,32.8 37.8,32.8 L39.2,32.8 C39.6,32.8 39.9,33.1 39.9,33.5 L39.9,41.2 C39.9,42.4 39,43.4 37.8,43.4 C37.4,43.4 37,43.2 36.6,43 L36.4,42.9 L30,37.5 L23.6,42.9 C22.7,43.6 21.5,43.5 20.7,42.8 L20.6,42.6 C20.3,42.3 20.1,41.9 20.1,41.4 L20.1,41.2 L20.1,20.1 C20.1,18.6 21.2,17.4 22.7,17.3 L22.9,17.25 L29.3,17.25 Z M39.2,17.25 C39.6,17.25 39.9,17.56 39.9,17.94 L39.9,21.5 L43.5,21.5 C43.9,21.5 44.2,21.8 44.2,22.2 L44.2,23.6 C44.2,24 43.9,24.3 43.5,24.3 L39.9,24.3 L39.9,27.9 C39.9,28.3 39.6,28.6 39.2,28.6 L37.8,28.6 C37.4,28.6 37.1,28.3 37.1,27.9 L37.1,24.3 L33.5,24.3 C33.1,24.3 32.8,24 32.8,23.6 L32.8,22.2 C32.8,21.8 33.1,21.5 33.5,21.5 L37.1,21.5 L37.1,17.9 C37.1,17.6 37.4,17.25 37.8,17.25 L39.2,17.25 Z" fill="#111319" fill-rule="nonzero"/>
            </svg>
        `;

        // --- MAIN LOGIC ---
        document.addEventListener("DOMContentLoaded", function () {
            const movieSlug = window.location.search.substring(1);

            if (!movieSlug) {
                document.getElementById('loadingMsg').textContent = "Vui lòng thêm ?[slug-phim] vào thanh địa chỉ.";
                return;
            }

            fetch(`https://phimapi.com/phim/${movieSlug}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status) {
                        document.title = `Diễn viên - ${data.movie.name}`;
                        const searchName = data.movie.origin_name || data.movie.name;
                        fetchTmdbData(searchName, data.movie.type);
                    } else {
                        document.getElementById('loadingMsg').textContent = "Không tìm thấy phim.";
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('loadingMsg').textContent = "Lỗi kết nối API.";
                });
        });

        async function fetchTmdbData(queryName, type) {
            try {
                const isTv = (type === 'series' || type === 'tvshows' || type === 'hoathinh');
                const searchType = isTv ? 'tv' : 'movie';

                const searchUrl = `${TMDB_BASE_URL}/search/${searchType}?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(queryName)}&language=vi-VN&page=1`;
                const searchRes = await fetch(searchUrl);
                const searchData = await searchRes.json();

                if (searchData.results && searchData.results.length > 0) {
                    const tmdbId = searchData.results[0].id;
                    const detailsUrl = `${TMDB_BASE_URL}/${searchType}/${tmdbId}/credits?api_key=${TMDB_API_KEY}&language=vi-VN`;
                    const creditsRes = await fetch(detailsUrl);
                    const creditsData = await creditsRes.json();

                    document.getElementById('loadingMsg').style.display = 'none';
                    renderCastList(creditsData.cast, creditsData.crew);
                } else {
                    document.getElementById('loadingMsg').innerHTML = "Không tìm thấy thông tin trên TMDB.";
                }
            } catch (error) {
                console.error("Lỗi TMDB:", error);
            }
        }

        async function renderCastList(cast, crew) {
            const container = document.getElementById('castListContainer');
            container.innerHTML = "";

            const director = crew.find(c => c.job === 'Director');
            let peopleList = [];

            if (director) {
                peopleList.push({ ...director, roleName: 'Đạo diễn' });
            }

            cast.forEach(c => {
                peopleList.push({ ...c, roleName: 'Diễn viên' });
            });

            for (const person of peopleList) {
                const personBlock = document.createElement('div');
                personBlock.className = 'person-block';

                // --- LOGIC ẢNH AVATAR + FALLBACK ---
                const avatarUrl = person.profile_path
                    ? TMDB_IMAGE_BASE + person.profile_path
                    : 'img/default_avatar.png'; // Nếu không có path thì dùng ảnh mặc định ngay

                let html = `
                    <div class="person-header">
                        <div class="person-avatar">
                            <img src="${avatarUrl}" alt="${person.name}" onerror="this.onerror=null; this.src='img/default_avatar.png';">
                        </div>
                        <div class="person-info">
                            <div class="person-name">${person.name}</div>
                            <div class="person-role">${person.roleName}</div>
                            <div class="more-link">
                                Khác <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                            </div>
                        </div>
                    </div>
                    <div class="person-movies-grid" id="movies-of-${person.id}">
                        </div>
                `;
                personBlock.innerHTML = html;
                container.appendChild(personBlock);

                fetchPersonCredits(person.id, `movies-of-${person.id}`);
            }
        }

        async function fetchPersonCredits(personId, containerId) {
            try {
                const url = `${TMDB_BASE_URL}/person/${personId}/combined_credits?api_key=${TMDB_API_KEY}&language=vi-VN`;
                const res = await fetch(url);
                const data = await res.json();

                let works = data.cast || [];
                if (works.length === 0) works = data.crew || [];

                works.sort((a, b) => b.popularity - a.popularity);

                const candidates = works.slice(0, 6);
                const gridContainer = document.getElementById(containerId);

                if (candidates.length > 0) {
                    const processedMovies = await Promise.all(candidates.map(async (w) => {
                        let result = null;
                        try {
                            const titleQuery = w.title || w.name;
                            const searchApiUrl = `https://phimapi.com/v1/api/tim-kiem?keyword=${encodeURIComponent(titleQuery)}&limit=10`;
                            const searchRes = await fetch(searchApiUrl);
                            const searchResult = await searchRes.json();

                            if (searchResult.status === 'success' && searchResult.data && searchResult.data.items) {
                                const match = searchResult.data.items.find(item =>
                                    item.tmdb && item.tmdb.id == w.id
                                );

                                if (match) {
                                    let poster = match.poster_url;
                                    if (!poster.startsWith('http')) {
                                        poster = PHIMAPI_IMAGE_BASE + poster;
                                    }
                                    result = {
                                        title: match.name,
                                        poster: poster,
                                        slug: match.slug
                                    };
                                }
                            }
                        } catch (err) {
                            console.log("Check API err", err);
                        }
                        return result;
                    }));

                    const finalMovies = processedMovies.filter(m => m !== null).slice(0, 2);

                    if (finalMovies.length > 0) {
                        let moviesHtml = "";
                        finalMovies.forEach(m => {
                            moviesHtml += `
                                <div class="movie-card-vertical" title="${m.title}" onclick="window.location.href='?${m.slug}'">
                                    <div class="poster-box">
                                        <img src="${m.poster}" alt="${m.title}">
                                        <div class="poster-overlay-gradient"></div>
                                        <div class="play-btn-center">${playBtnSvg}</div>
                                        <div class="collection-btn">
                                            ${collectionBtnSvg}
                                            <div class="tooltip-text">Sưu tập</div>
                                        </div>
                                    </div>
                                    <div class="poster-title">${m.title}</div>
                                </div>
                            `;
                        });
                        gridContainer.innerHTML = moviesHtml;
                    } else {
                        handleNoMovies(gridContainer);
                    }
                } else {
                    handleNoMovies(gridContainer);
                }
            } catch (e) {
                console.log("Err credits person", personId);
                const c = document.getElementById(containerId);
                if (c) handleNoMovies(c);
            }
        }

        function handleNoMovies(container) {
            if (!container) return;
            container.innerHTML = "";
            container.style.display = "none";
            const parentBlock = container.closest('.person-block');
            if (parentBlock) {
                const header = parentBlock.querySelector('.person-header');
                if (header) {
                    header.style.borderBottom = "none";
                    header.style.marginBottom = "0";
                    header.style.paddingBottom = "0";
                }
                parentBlock.style.paddingBottom = "24px";
            }
        }
    </script>
</body>

</html>